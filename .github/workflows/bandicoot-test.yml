name: Build and Test
on: [push, pull_request]

jobs:
  build:
    name: ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    outputs:
        tag: ${{ steps.git.outputs.tag }}
    strategy:
      fail-fast: false
      matrix:
        config:
          - { name: 'CUDA', os: self-hosted}
          - { name: 'OpenCL', os: self-hosted}
          - { name: 'CPU', os: self-hosted}
    steps:
    - uses: actions/checkout@v4
    - name: Install Dependencies
      run: |
        cd ../
        rm -rf bandicoot-code
        git clone --depth 1 --branch 2.1.1 https://gitlab.com/bandicoot-lib/bandicoot-code.git
        cd bandicoot-code/
        mkdir build/
        cd build/

        if [[ "${{ matrix.config.name }}" == "CUDA" ]]; then
            echo "Installing Bandicoot CUDA"
            cmake -DFIND_CUDA=ON -DFIND_OPENCL=OFF -DBUILD_TESTS=OFF ../
            make
        elif [[ "${{ matrix.config.name }}" == "OpenCL" ]]; then
            echo "Installing Bandicoot OpenCL"
            cmake -DFIND_CUDA=OFF -DFIND_OPENCL=ON -DBUILD_TESTS=OFF ../
            make
        fi

    - name: Build ensmallen
      run: |
          mkdir build
          cd build/

          if [[ "${{ matrix.config.name }}" == "CPU" ]]; then
              cmake -DUSE_BANDICOOT=OFF ..
          else
              cmake -DBANDICOOT_INCLUDE_DIR=../../bandicoot-code/build/tmp/include/ -DBANDICOOT_LIBRARY=../../bandicoot-code/build/libbandicoot.so ..
          fi

          make ensmallen_tests

    - name: Test ensmallen
      run: |
          cd build/
          ./ensmallen_tests